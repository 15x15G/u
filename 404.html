<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>重定向中...</title>
    <style>
        .main {
            border-style: solid;
            text-align: center;
            background-color: #eee;
            color: #222;
            border-radius: 10px;
            margin: auto;
            position: absolute;
            top: 50%;
            left: 20%;
            right: 20%;
            transform: translateY(-50%);
        }

        @font-face {
            font-family: 'FFXIV';
            src: url('https://cdn.jsdelivr.net/gh/15x15G/15x15G.github.io@gh-pages/fonts/FFXIV_Lodestone_SSF.ttf') format('truetype'),
                url('https://cdn.jsdelivr.net/gh/15x15G/15x15G.github.io@gh-pages/fonts/FFXIV_Lodestone_SSF.woff') format('woff');
            unicode-range: U+E020-E0DB;
            font-weight: 100 400;
        }
    </style>
</head>

<body>
    <div class="main">
        <p class="msg">重定向中...</p>
        <a class="link"></p>
    </div>
    <script type="module">
        import { Base64 } from 'https://cdn.jsdelivr.net/npm/js-base64@3.7.0/base64.mjs';

        // Format: https://api.github.com/repos/{owner}/{repo}/issues/
        const GITHUB_ISSUES_LINK = "https://api.github.com/repos/15x15G/u/issues/";
        const PATH_SEGMENTS_TO_SKIP = 1;
        const GITHUB_ISSUES_HTML = "https://github.com/15x15G/u/issues/";

        function isUrl(url) {
            // Regex from https://stackoverflow.com/a/3809435, with a modification to allow for TLDs of up to 24 characters
            return /^https?:\/\/(www\.)?[-a-zA-Z0-9@:%._\+~#=]{2,256}\.[a-z]{2,24}\b([-a-zA-Z0-9@:%_\+.~#?&//=]*)+$/.test(
                url
            );
        }

        class BASE {
            constructor() {
                this.convert = function (o, r, n) {
                    this.fromSymbols = "object" == typeof r ? r[0] : this.getsymbols(r), this.toSymbols = "object" == typeof n ? n[0] : this.getsymbols(n), r = this.fromSymbols.length, n = this.toSymbols.length; var i = [0]; for (o = o.split(""); o.length > 0 && i[i.push(this.fromSymbols.indexOf(o.pop())) - 1] >= 0;)
                        ; var h = i.shift() + i[i.length - 1] >= 0 ? i : null; if (null === h)
                        return null; for (var e = 0, l = (i = [], [1]); e < h.length; e++)
                        i = t(i, s(h[e], l, n), n), l = s(r, l, n); e = i.length - 1; for (var m = ""; e >= 0; m += this.toSymbols[i[e--]])
                        ; return 0 == m.length ? this.toSymbols[0] : m;
                }, this.symbols = { 32: function () { return this.base32hex; }, 36: ["[0-9][A-Z]"], 45: function () { return this["qr-alnum"]; }, 58: function () { return this.Bitcoin; }, 64: ["[A-Z][a-z][0-9]+/"], 85: function () { return this["RFC 1924"]; }, 91: ['[A-Z][a-z][0-9]!#$%&()*+,./:;<=>?@[]^_`{|}~"'], 94: ["[!-~]"], geohash: ["[0-9][b-h]jkmn[p-z]"], "RFC 4648": ["[A-Z][2-7]"], base32hex: ["[0-9][A-V]"], "qr-alnum": ["[0-9][A-Z] $%*+-./:"], Bitcoin: ["[1-9][A-H]JKLMN[P-Z][a-k][m-z]"], "RFC 1924": ["[0-9][A-Z][a-z]!#$%&()*+-;<=>?@^_`{|}~"] }, this.getsymbols = function (t) { return void 0 === this.symbols[t] && (this.symbols[t] = t < 95 ? this.rng(t < 64 ? "[0-9][A-Z][a-z]+" : "[A-Z][a-z][0-9][!-/][:-@][[-`][{-~]").substring(0, t) : this.rng("[\0-ÿ]").substring(256 - t, 256)), "function" == typeof this.symbols[t] && (this.symbols[t] = this.symbols[t]()), "object" == typeof this.symbols[t] && (this.symbols[t] = this.rng(this.symbols[t][0])), this.symbols[t]; }, this.rng = function (t) { var s = t.match(/\[.-.\]/); return null == s ? t : (s = [s[0].charCodeAt(1), s[0].charCodeAt(3)], this.rng(t.replace(RegExp("\\[(\\x" + ("0" + s[0].toString(16)).slice(-2) + "-\\x" + s[1].toString(16) + ")\\]", "g"), String.fromCharCode(..." ".repeat(s[1] - s[0] + 1).split("").map((t, o) => o + s[0]))))); }, this.selftest = function () {
                    var t = {}; for (var s in this.symbols)
                        t[s] = this.getsymbols(s).length; for (s = 2; s <= 95; s++)
                        t[s] = this.getsymbols(s).length; t[256] = 256; var o = ""; t = Object.keys(t).sort(function (s, o) { return t[s] - t[o]; }); for (var r in t) {
                            s = { fromBase: 10, toBASE: t[r] }; var n = this.convert("", 10, s.toBASE); o += "\r\noBASE.convert(n, '" + s.fromBase + "', '" + s.toBASE + "') [" + this.fromSymbols + "] [" + this.toSymbols + "]\r\n"; for (var i = 0; i < this.fromSymbols.length + 2; i++)
                                n = this.convert(String(i), s.fromBase, s.toBASE), o += i + (String(i) == this.convert(n, s.toBASE, s.fromBase) ? ">" : "?") + "[" + n + "] ";
                        } return o;
                }; var t = function (t, s, o) {
                    for (var r = Math.max(t.length, s.length), n = e = 0, i = []; e < r || n; n = Math.floor(h / o))
                        var h = n + (e < t.length ? t[e] : 0) + (e < s.length ? s[e] : 0), e = i.push(h % o); return i;
                }, s = function (s, o, r) {
                    for (var n = s < 0 ? null : []; s > 0; s >>= 1)
                        1 & s && (n = t(n, o, r)), o = t(o, o, r); return n;
                };
            }
        }

        function getQueryVariable(variable) {
            var query = window.location.search.substring(1);
            var vars = query.split("&");
            for (var i = 0; i < vars.length; i++) {
                var pair = vars[i].split("=");
                if (pair[0] == variable) { return pair[1]; }
            }
            return (false);
        }

        function check() {
            const part = window.location.pathname.split("/").filter(x => x != '');
            const lastpart = (part[part.length - 1]);
            if (lastpart.search('404') > -1) {
                document.querySelector('.msg').innerHTML = 404;
                document.querySelector('title').innerHTML = 404;
            }
            else if (isNaN(Number(lastpart))) {
                redirect_zero(lastpart.substring(0, lastpart.length - 1));
            }
            else {
                redirect_issue();
            }
        }

        function redirect_zero(str) {
            const oBASE = new BASE();
            let key = ''; for (let i = 0; i < 1024; i++) { key += String.fromCodePoint(i + 917504)[1]; }
            const z1024 = oBASE.rng(key);

            const msg = document.querySelector('.msg')
            const link = document.querySelector('.link')
            const headtitle = document.querySelector('title')
            try {
                if (str.length == 0) { throw 0; }
                str = decodeURIComponent(str);
                let fin = '';
                for (let s = 0; s < str.length; s++) {
                    if (s % 2 === 1)
                        fin += str[s];
                }
                fin = oBASE.convert(fin, [z1024], 64);
                fin = (Base64.decode(fin));


                if (isUrl(fin)) {
                    link.href = fin;
                    link.innerHTML = '正在前往...';
                    window.location.replace(fin);

                } else {
                    headtitle.innerHTML = '重定向失败';
                    msg.innerHTML = '重定向内容：';
                    link.href = "javascript:void(0);";
                    link.innerHTML = fin;
                }
            } catch (e) {
                headtitle.innerHTML = '重定向失败';
                msg.innerHTML = '重定向链接损坏';
            }
        }

        function redirect_issue() {
            const location = window.location;
            const part = location.pathname.split("/");
            const issueNumber = part[PATH_SEGMENTS_TO_SKIP + 1];
            const homepage = `${location.protocol}//${location.hostname}${location.port ? ":" + location.port : ""}/${part[PATH_SEGMENTS_TO_SKIP]}`

            const xhr = new XMLHttpRequest();

            const msg = document.querySelector('.msg')
            const link = document.querySelector('.link')
            const headtitle = document.querySelector('title')

            xhr.onload = function () {
                try {
                    const payload = JSON.parse(xhr.response);
                    const message = payload.message;
                    const title = payload.title;

                    // Workaround IE 11 lack of support for new URL()
                    const url = document.createElement("a");
                    url.setAttribute("href", title);

                    if (message === "Not Found") {
                        headtitle.innerHTML = '重定向失败';
                        msg.innerHTML = '重定向链接不存在';
                        link.href = GITHUB_ISSUES_HTML;
                        link.innerHTML = '猜你想找';
                    } else if (!title || !isUrl(title)) {
                        headtitle.innerHTML = '重定向失败';
                        msg.innerHTML = '重定向链接损坏';
                        link.href = GITHUB_ISSUES_HTML + issueNumber;
                        link.innerHTML = '猜你想找';
                    } else if (url.href === location.href) {
                        headtitle.innerHTML = '重定向失败';
                        msg.innerHTML = '重定向链接套娃';
                        link.href = GITHUB_ISSUES_HTML + issueNumber;
                        link.innerHTML = '猜你想套';
                    }
                    else {
                        link.href = title;
                        link.innerHTML = '正在前往...';
                        location.replace(title);
                    }
                } catch (e) {
                    headtitle.innerHTML = '重定向失败';
                    msg.innerHTML = '网络错误，请刷新页面';
                }
            };

            xhr.onerror = function () {
                headtitle.innerHTML = '重定向失败';
                msg.innerHTML = '网络错误，请刷新页面';
                //location.replace(homepage);
            };
            xhr.open("GET", GITHUB_ISSUES_LINK + issueNumber);
            xhr.send();
        }

        check();
    </script>
</body>

</html>